---
const { pageKey } = Astro.props

const server = import.meta.env.PUBLIC_ARTALK_SERVER
const site = import.meta.env.PUBLIC_ARTALK_SITE

// 提取服务器 URL 用于预连接
const serverUrl = server ? new URL(server.replace(/\/+$/, ''), 'https://example.com').origin : ''
---

<!-- 预连接到 Artalk 服务器，提升资源加载优先级 -->
{serverUrl && (
  <>
    <link rel="preconnect" href={serverUrl} crossorigin />
    <link rel="dns-prefetch" href={serverUrl} />
    <link rel="preload" href={`${server.replace(/\/+$/, '')}/dist/Artalk.css`} as="style" />
    <link rel="preload" href={`${server.replace(/\/+$/, '')}/dist/Artalk.js`} as="script" fetchpriority="high" />
  </>
)}

<div id="artalk"></div>

<script is:inline define:vars={{ server, site }}>
  function ensureArtalkCSS() {
    if (!document.getElementById('artalk-css')) {
      const link = document.createElement('link')
      link.id = 'artalk-css'
      link.rel = 'stylesheet'
      link.href = server.replace(/\/+$/, '') + '/dist/Artalk.css'
      document.head.appendChild(link)
    }
  }

  function bindThemeSync(at) {
    const apply = () => {
      const isDark = document.documentElement.classList.contains('dark')
      at.setDarkMode(isDark)
    }

    apply()

    const mo = new MutationObserver(apply)
    mo.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class'],
    })

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', apply)
  }

  function loadArtalk() {
    const el = document.querySelector('#artalk')
    if (!el)
return

    ensureArtalkCSS()

    const init = () => {
      const at = window.Artalk.init({
        el: '#artalk',
        server,
        site,
        // pageKey,
        pageTitle: document.title,
        locale: 'zh-CN',
      })
      bindThemeSync(at)
    }

    if (!window.Artalk) {
      const script = document.createElement('script')
      script.src = server.replace(/\/+$/, '') + '/dist/Artalk.js'
      // 移除 defer，添加 fetchpriority 提升加载优先级
      script.fetchPriority = 'high'
      script.onload = init
      document.body.appendChild(script)
    }
 else {
      init()
    }
  }

  // 立即开始加载，不等待 DOMContentLoaded
  // 使用 requestIdleCallback 在空闲时加载，或直接加载
  if ('requestIdleCallback' in window) {
    requestIdleCallback(loadArtalk, { timeout: 1000 })
  } else if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadArtalk)
  } else {
    loadArtalk()
  }
</script>

<style is:inline>
  .artalk, .atk-layer-wrap {
    --at-color-main: #e5c185 !important;
  }
.atk-grp-switcher {
  display: flex;
  overflow-x: auto;
  overflow-y: hidden; /* Hide vertical scrollbar */
  white-space: nowrap;
  height: 35px !important; /* You can adjust this value */
}

/* Hide default scrollbar */
.atk-grp-switcher::-webkit-scrollbar {
  height: 5px; /* Height of scrollbar */
}

/* Customize scrollbar track */
.atk-grp-switcher::-webkit-scrollbar-track {
  background: transparent; 
}

/* Customize scrollbar thumb */
.atk-grp-switcher::-webkit-scrollbar-thumb {
  background-color: var(--at-color-main);
  border-radius: 3px;
}
</style>